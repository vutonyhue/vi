const s="FUN_WALLET_RPC",l=new Map;function h(){try{return localStorage.getItem("FUN_WALLET_DEBUG")==="1"}catch{return!1}}function d(e,r){if(h()){if(r===void 0){console.log(`[FUN Wallet][bridge] ${e}`);return}console.log(`[FUN Wallet][bridge] ${e}`,r)}}function p(e){const r=Array.isArray(e)?e[0]:e;if(!r||typeof r!="object")return{};const o=r;return{from:typeof o.from=="string"?o.from:void 0,to:typeof o.to=="string"?o.to:void 0,value:typeof o.value=="string"?o.value:void 0,dataLength:typeof o.data=="string"?o.data.length:void 0}}function g(e){return typeof e=="string"&&/^0x[0-9a-fA-F]+$/.test(e)}function u(){try{const e=document.createElement("script");e.src=chrome.runtime.getURL("inpage.js"),e.type="text/javascript",e.onload=()=>e.remove(),e.onerror=o=>{console.error("[FUN Wallet] Failed to load inpage script:",o)},(document.documentElement||document.head).appendChild(e)}catch(e){console.error("[FUN Wallet] Failed to inject provider:",e)}}window.addEventListener("message",async e=>{const r=e.data;if(e.source!==window||!r||r.channel!==s||r.direction!=="from_inpage"||!r.id||!r.method)return;const o=r.method==="eth_sendTransaction";o&&d(`request ${r.method} (${r.id})`,p(r.params));try{const n=await new Promise(i=>{chrome.runtime.sendMessage({type:"FUN_WALLET_BRIDGE_RPC",payload:{channel:s,id:r.id,method:r.method,params:r.params,origin:window.location.origin}},c=>{if(chrome.runtime.lastError){i({error:chrome.runtime.lastError.message});return}i(c||{error:"No response from background"})})}),t=n?.data,a={channel:s,direction:"to_inpage",id:r.id};if(t?.error||n.error){const i=t?.error||(typeof n.error=="string"?{code:-32603,message:n.error}:{code:-32603,message:"Bridge error"}),c=typeof i=="object"&&i&&"code"in i?i.code:void 0;if(o&&c===4001){l.set(r.id,{method:r.method}),d(`pending user approval ${r.method} (${r.id})`);return}o&&d(`error ${r.method} (${r.id})`,i),a.error=i}else o&&d(`response ${r.method} (${r.id})`,t?.result),a.result=t?.result;window.postMessage(a,"*")}catch(n){const t={channel:s,direction:"to_inpage",id:r.id,error:{code:-32603,message:n instanceof Error?n.message:"Bridge error"}};o&&d(`bridge exception ${r.method} (${r.id})`,t.error),window.postMessage(t,"*")}});chrome.runtime.onMessage.addListener(e=>{if(!e?.type)return;const r=(o,n)=>{const t={channel:s,direction:"to_inpage_event",event:o,data:n};window.postMessage(t,"*")};switch(e.type){case"FUN_WALLET_RESPONSE":{const o=typeof e.requestId=="string"?e.requestId:"";if(!o)break;const n=l.get(o);if(!n)break;const t={channel:s,direction:"to_inpage",id:o};e.result!==void 0?g(e.result)?(t.result=e.result,d(`resolved ${n.method} (${o})`,{txHash:e.result})):(t.error={code:-32603,message:"Invalid transaction hash from wallet"},d(`invalid tx hash ${n.method} (${o})`,e.result)):e.error?(t.error=typeof e.error=="string"?{code:4001,message:e.error}:{code:-32603,message:"Request failed"},d(`rejected ${n.method} (${o})`,t.error)):(t.error={code:-32603,message:"Missing response payload"},d(`missing response payload ${n.method} (${o})`)),l.delete(o),window.postMessage(t,"*");break}case"chainChanged":r("chainChanged",e.chainId);break;case"accountsChanged":r("accountsChanged",e.accounts);break;case"disconnect":r("disconnect",{code:4900,message:"Disconnected"});break;case"connect":r("connect",{chainId:e.chainId});break}});document.readyState,u();
