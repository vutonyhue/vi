import{S as g,d as $,i as _}from"./encryption-ChsFRMua.js";class z{async get(r){try{return(await chrome.storage.local.get(r))[r]||null}catch(t){return console.error("[ChromeStorageAdapter] Error getting key:",r,t),null}}async set(r,t){try{await chrome.storage.local.set({[r]:t})}catch(s){throw console.error("[ChromeStorageAdapter] Error setting key:",r,s),new Error(`Failed to save data: ${s}`)}}async remove(r){try{await chrome.storage.local.remove(r)}catch(t){console.error("[ChromeStorageAdapter] Error removing key:",r,t)}}async getAll(){try{return await chrome.storage.local.get(null)}catch(r){return console.error("[ChromeStorageAdapter] Error getting all:",r),{}}}async has(r){try{return(await chrome.storage.local.get(r))[r]!==void 0}catch(t){return console.error("[ChromeStorageAdapter] Error checking key:",r,t),!1}}async clear(){try{const r=await chrome.storage.local.get(null),t=Object.keys(r).filter(s=>s.startsWith("fun_wallet"));await chrome.storage.local.remove(t)}catch(r){console.error("[ChromeStorageAdapter] Error clearing:",r)}}}const p=new z,B=[{chainId:56,name:"BNB Smart Chain",shortName:"BSC",rpcUrl:"https://bsc-dataseed.binance.org/",symbol:"BNB",explorer:"https://bscscan.com",logo:"/tokens/bnb.png",color:"#F3BA2F",isTestnet:!1},{chainId:1,name:"Ethereum Mainnet",shortName:"ETH",rpcUrl:"https://eth.llamarpc.com",symbol:"ETH",explorer:"https://etherscan.io",logo:"/tokens/eth.svg",color:"#627EEA",isTestnet:!1},{chainId:137,name:"Polygon",shortName:"MATIC",rpcUrl:"https://polygon-rpc.com",symbol:"MATIC",explorer:"https://polygonscan.com",logo:"/tokens/matic.svg",color:"#8247E5",isTestnet:!1},{chainId:42161,name:"Arbitrum One",shortName:"ARB",rpcUrl:"https://arb1.arbitrum.io/rpc",symbol:"ETH",explorer:"https://arbiscan.io",logo:"/tokens/eth.svg",color:"#28A0F0",isTestnet:!1},{chainId:10,name:"Optimism",shortName:"OP",rpcUrl:"https://mainnet.optimism.io",symbol:"ETH",explorer:"https://optimistic.etherscan.io",logo:"/tokens/eth.svg",color:"#FF0420",isTestnet:!1},{chainId:43114,name:"Avalanche C-Chain",shortName:"AVAX",rpcUrl:"https://api.avax.network/ext/bc/C/rpc",symbol:"AVAX",explorer:"https://snowtrace.io",logo:"/tokens/avax.svg",color:"#E84142",isTestnet:!1},{chainId:250,name:"Fantom Opera",shortName:"FTM",rpcUrl:"https://rpc.ftm.tools/",symbol:"FTM",explorer:"https://ftmscan.com",logo:"/tokens/default.svg",color:"#1969FF",isTestnet:!1},{chainId:8453,name:"Base",shortName:"BASE",rpcUrl:"https://mainnet.base.org",symbol:"ETH",explorer:"https://basescan.org",logo:"/tokens/eth.svg",color:"#0052FF",isTestnet:!1}],G=e=>B.find(r=>r.chainId===e),L={eth_sendTransaction:"eth_sendTransaction",personal_sign:"personal_sign",eth_signTypedData_v4:"eth_signTypedData",wallet_switchEthereumChain:"wallet_switchEthereumChain"};let f=!0;const j=[56,1,137,42161,10,8453,43114,250],R=new Map(j.map(e=>[e,G(e)]).filter(e=>!!e[1]));function T(e){return`0x${e.toString(16)}`}function b(e){if(typeof e=="number"&&Number.isInteger(e)&&e>0)return e;if(typeof e!="string")return null;const r=e.trim();if(!r)return null;if(/^0x[0-9a-fA-F]+$/.test(r)){const t=parseInt(r,16);return Number.isInteger(t)&&t>0?t:null}if(/^\d+$/.test(r)){const t=parseInt(r,10);return Number.isInteger(t)&&t>0?t:null}return null}function D(e){return R.has(e)}let w=56,A=T(w),F=R.get(w)||null;function W(e){const r=R.get(e);return r?(w=e,A=T(e),F=r,!0):!1}const h=new Map,d=new Map;function E(e){return!!e&&typeof e=="object"&&!Array.isArray(e)}function i(e,r){return{success:!1,error:{code:e,message:r}}}function V(e){return typeof e=="string"&&/^0x[0-9a-fA-F]+$/.test(e)}function I(e){if(e)try{return new URL(e).origin}catch{return}}function J(e){const r=I(e);return r&&h.get(r)||null}function K(e){return e in L?L[e]:null}function q(e){if(Array.isArray(e))return e;if(E(e)){const r=e.paramsRaw;if(Array.isArray(r))return r;if(r!==void 0)return[r];const t=e.params;if(Array.isArray(t))return t;if(t!==void 0)return[t]}return[]}function N(e,r){if(E(e)&&Object.keys(e).length>0&&!Array.isArray(e))return"method"in e||"paramsRaw"in e||"params"in e?void 0:e;if(r.length===1&&E(r[0]))return r[0]}function Y(e){const r=q(e),s=N(e,r)||(E(r[0])?r[0]:void 0);if(!s||!s.to||typeof s.to!="string")return{error:{code:-32602,message:"Invalid transaction request"}};const a={...s};(a.chainId===void 0||a.chainId===null||a.chainId==="")&&(a.chainId=A);const o=b(a.chainId);return o?D(o)?o!==w?{error:{code:-32602,message:`Chain mismatch: wallet is on ${A}, tx requested ${T(o)}`}}:F?(a.chainId=T(o),{tx:a}):{error:{code:-32602,message:"Unsupported chainId"}}:{error:{code:-32602,message:"Unsupported chainId"}}:{error:{code:-32602,message:"Invalid chainId"}}}function X(e){const r=q(e),t=N(e,r);if(t?.message&&typeof t.message=="string")return{message:t.message,address:t.address};const s=r[0],a=r[1];return typeof s=="string"&&typeof a=="string"?_(s)&&!_(a)?{message:a,address:s}:_(a)&&!_(s)?{message:s,address:a}:{message:s,address:a}:typeof s=="string"?{message:s}:{error:{code:-32602,message:"Invalid personal_sign parameters"}}}function Q(e){const r=q(e),t=N(e,r);return t?.address&&t?.data?{address:t.address,data:t.data}:typeof r[0]=="string"&&typeof r[1]=="string"?{address:r[0],data:r[1]}:{error:{code:-32602,message:"Invalid eth_signTypedData_v4 parameters"}}}function Z(e){const r=q(e),t=N(e,r);return t?.chainId&&typeof t.chainId=="string"?{chainId:t.chainId}:E(r[0])&&typeof r[0].chainId=="string"?{chainId:r[0].chainId}:{error:{code:-32602,message:"Invalid wallet_switchEthereumChain parameters"}}}function O(e,r){const t=new Set(e.accounts.map(s=>s.toLowerCase()));return r&&t.has(r.toLowerCase())?r:e.accounts[0]}function y(e,r){const t=K(e);if(!t)return null;const s=J(r);return s?s.permissions.includes(t)?null:i(4100,`Missing permission: ${t}`):i(4100,"DApp not connected")}async function ee(e,r){if(!e||typeof e!="object")return{success:!1,error:{code:-32600,message:"Invalid bridge payload"}};const t=e;if(t.channel!=="FUN_WALLET_RPC"||!t.id||!t.method)return{success:!1,error:{code:-32600,message:"Invalid bridge request envelope"}};const s=t.method;if(!["eth_chainId","net_version","eth_requestAccounts","eth_accounts","wallet_switchEthereumChain","eth_sendTransaction","personal_sign","eth_signTypedData_v4","wallet_getPermissions","wallet_requestPermissions"].includes(s))return{success:!0,data:{id:t.id,error:{code:-32601,message:`Method not supported: ${t.method}`}}};const o={type:s,requestId:t.id,origin:t.origin||r.tab?.url,payload:{method:t.method,paramsRaw:t.params}},c=await M(o,r,()=>{});return c?.success?{success:!0,data:{id:t.id,result:c.data}}:c?.pending?{success:!0,data:{id:t.id,error:{code:4001,message:"Pending user approval"}}}:{success:!0,data:{id:t.id,error:typeof c?.error=="string"?{code:-32603,message:c.error}:c?.error||{code:-32603,message:"Request failed"}}}}async function re(){console.log("[FUN Wallet] Service worker initializing...");const e=await p.get(g.DAPP_CONNECTIONS);if(e)try{JSON.parse(e).forEach(s=>h.set(s.origin,s))}catch(t){console.error("[FUN Wallet] Error loading DApps:",t)}const r=await p.get(g.CURRENT_CHAIN);if(r){const t=b(r);t&&D(t)&&W(t)}console.log("[FUN Wallet] Service worker initialized")}chrome.runtime.onMessage.addListener((e,r,t)=>(console.log("[FUN Wallet] Message received:",e.type),M(e,r,t).then(s=>{s&&t(s)}).catch(s=>t({success:!1,error:s.message})),!0));async function M(e,r,t){const s=I(e.origin||r.tab?.url||"")||e.origin||r.tab?.url,a=r.tab?.id,o=e.requestId;switch(e.type){case"FUN_WALLET_BRIDGE_RPC":return ee(e.payload,r);case"IS_UNLOCKED":return{success:!0,data:{unlocked:!f}};case"UNLOCK_WALLET":return te(e.payload);case"LOCK_WALLET":return f=!0,{success:!0};case"GET_ACCOUNTS":case"eth_accounts":return x(s);case"eth_requestAccounts":return H(s,a,t,o);case"GET_CURRENT_CHAIN":case"eth_chainId":return{success:!0,data:A};case"net_version":return{success:!0,data:w.toString()};case"SWITCH_CHAIN":return U(e.payload);case"wallet_switchEthereumChain":{const c=y("wallet_switchEthereumChain",s);if(c)return c;const n=Z(e.payload);return n.error||!n.chainId?i(n.error?.code||-32602,n.error?.message||"Invalid chainId"):U({chainId:n.chainId})}case"wallet_requestPermissions":return oe(e.payload,s,a,t,o);case"wallet_getPermissions":return ce(s);case"eth_sendTransaction":case"SIGN_TRANSACTION":{const c=e.type==="eth_sendTransaction"?y("eth_sendTransaction",s):null;if(c)return c;const n=Y(e.payload);return n.error||!n.tx?i(n.error?.code||-32602,n.error?.message||"Invalid transaction"):ue(n.tx,s,a,t,o)}case"personal_sign":case"PERSONAL_SIGN":{const c=e.type==="personal_sign"?y("personal_sign",s):null;if(c)return c;const n=X(e.payload);return n.error||!n.message?i(n.error?.code||-32602,n.error?.message||"Invalid personal_sign request"):he({message:n.message,address:n.address},s,a,t,o)}case"eth_signTypedData_v4":{const c=y("eth_signTypedData_v4",s);if(c)return c;const n=Q(e.payload);return n.error||!n.address||!n.data?i(n.error?.code||-32602,n.error?.message||"Invalid typed data request"):ge({address:n.address,data:n.data},s,a,t,o)}case"GET_PENDING_REQUEST":return ne(e.payload);case"APPROVE_CONNECTION":return ae(e.payload);case"REJECT_CONNECTION":return ie(e.payload);case"APPROVE_TRANSACTION":return de(e.payload);case"REJECT_TRANSACTION":return le(e.payload);case"APPROVE_SIGN":return pe(e.payload);case"REJECT_SIGN":return fe(e.payload);case"CONNECT_DAPP":return me(s,e.payload);case"DISCONNECT_DAPP":return Ie(e.payload);case"DISCONNECT_ALL_DAPPS":return _e();case"GET_CONNECTED_DAPPS":return{success:!0,data:Array.from(h.values())};default:return{success:!1,error:`Unknown message type: ${e.type}`}}}async function te(e){if(!e?.password)return{success:!1,error:"Password required"};try{const r=await p.get(g.ENCRYPTED_KEYS);if(!r)return{success:!1,error:"No wallet found"};const t=JSON.parse(r),s=Object.keys(t.wallets);if(s.length===0)return{success:!1,error:"No wallet found"};const a=t.wallets[s[0]];return await $(a,e.password),f=!1,await p.set(g.LAST_ACTIVITY,Date.now().toString()),console.log("[FUN Wallet] Wallet unlocked successfully"),{success:!0}}catch(r){return console.error("[FUN Wallet] Unlock failed:",r),{success:!1,error:"Mật khẩu không đúng"}}}async function x(e){if(f)return{success:!0,data:[]};if(e)try{const t=new URL(e),s=h.get(t.origin);return s?{success:!0,data:s.accounts||[]}:{success:!0,data:[]}}catch{}const r=await p.get(g.ACTIVE_WALLET);return{success:!0,data:r?[r]:[]}}function se(){return["eth_accounts","eth_sendTransaction","personal_sign","eth_signTypedData","wallet_switchEthereumChain"]}function k(e){const r=[];return e.includes("eth_accounts")&&r.push({parentCapability:"eth_accounts"}),r}async function H(e,r,t,s,a="eth_requestAccounts"){if(!e)return{success:!1,error:"Origin required"};let o;try{o=new URL(e).origin}catch{o=e}if(h.has(o))return x(o);const c=s||`connect_${Date.now()}`,n={id:c,method:a,params:[],origin:o,timestamp:Date.now(),tabId:r};return d.set(c,n),f?await S("connect",{requestId:c,origin:o}):await P("connect",{requestId:c,origin:o}),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}}}function ne(e){const r=d.get(e.requestId);return r?{success:!0,data:r}:{success:!1,error:"Request not found"}}async function ae(e){const r=d.get(e.requestId);if(!r)return{success:!1,error:"Request not found or expired"};const t=I(e.origin);if(!t)return i(-32602,"Invalid origin");const s=await p.get(g.ACTIVE_WALLET),a=Array.isArray(e.accounts)?e.accounts.filter(Boolean):[],o=a.length>0?a:s?[s]:[],c=e.permissions&&e.permissions.length>0?e.permissions:se(),n={origin:t,name:new URL(t).hostname,connectedAt:Date.now(),permissions:c,chainId:w,accounts:o};h.set(t,n),await v();const u=k(n.permissions),l=r.method==="wallet_requestPermissions"?u:n.accounts;return r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,result:l}).catch(console.error),d.delete(e.requestId),C("connect",{chainId:A}),C("accountsChanged",n.accounts),{success:!0,data:l}}async function oe(e,r,t,s,a){const o=await H(r,t,s,a,"wallet_requestPermissions");return o.success?{success:!0,data:[{parentCapability:"eth_accounts"}]}:o}function ce(e){if(!e)return{success:!0,data:[]};try{const r=new URL(e).origin,t=h.get(r);return t?{success:!0,data:k(t.permissions)}:{success:!0,data:[]}}catch{return{success:!0,data:[]}}}function ie(e){const r=d.get(e.requestId);return r?(r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,error:"User rejected connection"}).catch(console.error),d.delete(e.requestId),{success:!0}):{success:!1,error:"Request not found"}}async function U(e){if(!e?.chainId||typeof e.chainId!="string")return i(-32602,"Invalid chainId");const r=b(e.chainId);return r?D(r)?(W(r),await p.set(g.CURRENT_CHAIN,r.toString()),C("chainChanged",A),{success:!0}):i(-32602,"Unsupported chainId"):i(-32602,"Invalid chainId")}async function ue(e,r,t,s,a){const o=I(r);if(!o)return i(-32602,"Origin required");const c=h.get(o);if(!c)return i(4100,"DApp not connected");const n=e.from&&_(e.from)?e.from:void 0,u=O(c,n);if(!u)return i(4100,"No permitted account available");if(n&&n.toLowerCase()!==u.toLowerCase())return i(4100,"Requested account is not authorized");const l={to:e.to||"",value:e.value||"0",origin:o||"unknown",from:u};e.data&&(l.data=e.data);const m=a||`tx_${Date.now()}`;return d.set(m,{id:m,method:"eth_sendTransaction",params:[{...e,from:u}],origin:o,timestamp:Date.now(),tabId:t,requestedAccount:u,requiredPermission:"eth_sendTransaction"}),l.requestId=m,f?(await S("approve-tx",l),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}}):(await P("approve-tx",l),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}})}async function de(e){const r=d.get(e.requestId);return r?V(e.txHash)?(r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,result:e.txHash}).catch(console.error),d.delete(e.requestId),{success:!0,data:e.txHash}):(r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,error:"Invalid transaction hash from wallet"}).catch(console.error),d.delete(e.requestId),i(-32603,"Invalid transaction hash from wallet")):{success:!1,error:"Request not found or expired"}}function le(e){const r=d.get(e.requestId);return r?(r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,error:"User rejected transaction"}).catch(console.error),d.delete(e.requestId),{success:!0}):{success:!1,error:"Request not found"}}async function he(e,r,t,s,a){const o=I(r);if(!o)return i(-32602,"Origin required");const c=h.get(o);if(!c)return i(4100,"DApp not connected");const n=e.address&&_(e.address)?e.address:void 0,u=O(c,n);if(!u)return i(4100,"No permitted account available");if(n&&n.toLowerCase()!==u.toLowerCase())return i(4100,"Requested account is not authorized");const l=a||`sign_${Date.now()}`;d.set(l,{id:l,method:"personal_sign",params:[e.message,u],origin:o,timestamp:Date.now(),tabId:t,requestedAccount:u,requiredPermission:"personal_sign"});const m={requestId:l,message:e.message,address:u,origin:o,method:"personal_sign"};return f?(await S("approve-sign",m),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}}):(await P("approve-sign",m),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}})}async function ge(e,r,t,s,a){const o=I(r);if(!o)return i(-32602,"Origin required");const c=h.get(o);if(!c)return i(4100,"DApp not connected");const n=e.address&&_(e.address)?e.address:void 0;if(!n)return i(-32602,"Invalid signer address");const u=O(c,n);if(!u)return i(4100,"No permitted account available");if(n.toLowerCase()!==u.toLowerCase())return i(4100,"Requested account is not authorized");const l=a||`signTyped_${Date.now()}`;d.set(l,{id:l,method:"eth_signTypedData_v4",params:[u,e.data],origin:o,timestamp:Date.now(),tabId:t,requestedAccount:u,requiredPermission:"eth_signTypedData"});const m={requestId:l,message:e.data,address:u,origin:o,method:"eth_signTypedData_v4"};return f?(await S("approve-sign",m),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}}):(await P("approve-sign",m),{success:!1,pending:!0,error:{code:4001,message:"Pending user approval"}})}async function pe(e){const r=d.get(e.requestId);return r?(r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,result:e.signature}).catch(console.error),d.delete(e.requestId),{success:!0,data:{signature:e.signature}}):{success:!1,error:"Request not found or expired"}}function fe(e){const r=d.get(e.requestId);return r?(r.tabId&&chrome.tabs.sendMessage(r.tabId,{type:"FUN_WALLET_RESPONSE",requestId:e.requestId,error:"User rejected signing"}).catch(console.error),d.delete(e.requestId),{success:!0}):{success:!1,error:"Request not found"}}async function me(e,r){const t=I(e);if(!t)return i(-32602,"Invalid origin");const s={origin:t,name:new URL(t).hostname,connectedAt:Date.now(),permissions:["eth_accounts"],chainId:w,accounts:[]},a=await p.get(g.ACTIVE_WALLET);return a&&(s.accounts=[a]),h.set(t,s),await v(),{success:!0,data:s}}async function Ie(e){const r=I(e.origin);return r?(h.delete(r),await v(),C("disconnect",{code:4900,message:"Disconnected"}),{success:!0}):i(-32602,"Invalid origin")}async function _e(){return h.clear(),await v(),C("disconnect",{code:4900,message:"Disconnected"}),{success:!0}}async function v(){const e=Array.from(h.values());await p.set(g.DAPP_CONNECTIONS,JSON.stringify(e))}async function P(e,r){const t=r?`?${new URLSearchParams(r).toString()}`:"";await chrome.windows.create({url:chrome.runtime.getURL(`popup.html#/${e}${t}`),type:"popup",width:360,height:600,focused:!0})}async function S(e,r){const t=new URLSearchParams(r).toString(),s=`${e}?${t}`,a=encodeURIComponent(s);await chrome.windows.create({url:chrome.runtime.getURL(`popup.html#/unlock?redirect=${a}`),type:"popup",width:360,height:600,focused:!0})}function C(e,r){chrome.tabs.query({},t=>{t.forEach(s=>{s.id&&chrome.tabs.sendMessage(s.id,{type:e,...e==="chainChanged"?{chainId:r}:{},...e==="accountsChanged"?{accounts:r}:{},...e==="disconnect"||e==="connect"?r:{}}).catch(()=>{})})})}re();setInterval(async()=>{if(!f){const e=await p.get(g.LAST_ACTIVITY);if(e){const r=Date.now()-parseInt(e),t=15*60*1e3;r>t&&(console.log("[FUN Wallet] Auto-locking due to inactivity"),f=!0)}}},6e4);chrome.runtime.onInstalled.addListener(e=>{console.log("[FUN Wallet] Extension installed:",e.reason)});
